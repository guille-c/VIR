#include <stdio.h>
#include "mathconst.h"
#include "cbi_beam.h"

/* Profile of the CBI primary beam for x=0..4 in steps of 0.01
   where x = theta * rmax/lambda (rmax = 45 cm for CBI).
   [Computed in Mathematica; TJP 7/11/2001] */

#define SIZE_PROFILE 401
#define STEP_PROFILE 0.01

/* Beam with designed grading a = 0.8261 */

static double design_profile[SIZE_PROFILE] = 
{0.9999999999999998,0.9992037028303761,0.9968180791427593,
 0.9928529129997211,0.987324446643794,0.98025528420141,0.971674257857261,
 0.9616162574779169,0.9501220249290488,0.9372379145856619,
 0.9230156217771897,0.9075118811372432,0.8907881370392275,
 0.8729101884923478,0.8539478110460642,0.8339743584035592,
 0.8130663465749496,0.791303023507955,0.7687659272166735,0.7455384354875122,
 0.7217053102748457,0.6973522399075093,0.6725653822109247,0.64743091160884,
 0.6220345732038712,0.596461246748091,0.5707945233047127,0.5451162972707007,
 0.5195063762791526,0.49404211133113857,0.46879804932089475,
 0.44384560991772914,0.4192527885544953,0.39508388704812947,
 0.37139927314444904,0.348255170039439,0.32570347668462485,
 0.3037916194371083,0.2825624353675123,0.26205408729362734,
 0.24230001036601156,0.2233288897962182,0.20516466909062503,
 0.18782658793483706,0.1713292486671114,0.15568271008565956,
 0.1408926071556104,0.1269602950180326,0.11388301555688563,
 0.1016540846510232,0.09026309812817723,0.07969615434676432,
 0.06993609125979706,0.06096273576332173,0.052753163099678535,
 0.045281964073313,0.038521517843513736,0.032442268083798395,
 0.02701300034103123,0.022201118487905142,0.017972918239176596,
 0.014293855793903175,0.011128809771675045,0.00844233472913166,
 0.006198904672500902,0.004363145121007596,0.002900052423235546,
 0.00177519918231296,0.0009549248045284039,0.00040651034806864244,
 0.00009833701240285267,2.777285456465567e-8,0.00008257182757035731,
 0.0003184316839417117,0.0006816328671558537,0.001147836383618612,
 0.0016943942152739724,0.0023003882562094287,0.0029466532293636063,
 0.0036157842377406305,0.00429212971050565,0.004961770599040371,
 0.005612486760957161,0.006233711540824013,0.006816475614688384,
 0.007353341211291228,0.007838327856143844,0.008266830805541013,
 0.008635533346362894,0.008942314134551897,0.009186150730919615,
 0.009367020468027802,0.00948579974696502,0.009544162818659763,
 0.009544481051755154,0.00948972362889643,0.009383360546482318,
 0.009229268720467192,0.009031641923658828,0.008794905199146918,
 0.008523634311013203,0.008222480708317279,0.007896102392498855,
 0.007549100992725005,0.007185965269258429,0.00681102118247591,
 0.006428388585543823,0.00604194452268265,0.005655293043119169,
 0.00527174137380931,0.004894282232360563,0.004525582005711722,
 0.004167974470409241,0.0038234596870218257,0.003493707664549074,
 0.0031800663607106593,0.002883573560774508,0.0026049721610443255,
 0.0023447283731449003,0.00210305236162026,0.0018799208298294534,
 0.0016751010773586052,0.001488176065787339,0.0013185700482223272,
 0.0011655743410749978,0.001028372843604078,0.0009060669412485575,
 0.0007976994621818453,0.0007022773922736667,0.0006187930911836459,
 0.000546243791066955,0.00048364919879756137,0.00043006706217245714,
 0.0003846065997328581,0.0003464397321398061,0.00031481009001876675,
 0.00028903980841773786,0.00026853415113033775,0.0002527840387880823,
 0.000241366582527104,0.00023394374995610917,0.00023025931189288865,
 0.00023013423676104843,0.00023346071455317567,0.0002401950038292045,
 0.00025034930333404855,0.00026398285453693455,0.0002811924828106535,
 0.00030210278321495605,0.00032685615209730143,0.00035560285817817837,
 0.0003884913366834451,0.00042565887767846033,0.00046722286533128747,
 0.0005132727086765099,0.0005638625868788249,0.0006190051133169318,
 0.0006786660033446602,0.0007427598106484268,0.0008111467770210147,
 0.0008836308204094213,0.0009599586665532482,0.0010398201106802888,
 0.001122849377815963,0.001208627533516703,0.001296685881458827,
 0.001386510270470175,0.0014775462214391744,0.0015692047741761486,
 0.0016608689458331046,0.0017519006859612438,0.0018416482087240075,
 0.0019294535801921745,0.0020146604379856557,0.002096621721746976,
 0.0021747072959392853,0.002248311351165145,0.0023168594764636547,
 0.002379815302723579,0.0024366866262889365,0.0024870309318580316,
 0.0025304602447038583,0.002566645253882277,0.002595318660256384,
 0.002616277715648151,0.0026293859320452276,0.002634573952350671,
 0.002631839586483328,0.0026212470285430244,0.002602925282093979,
 0.002577065831230701,0.002543919604854961,0.0025037932903813204,
 0.002457045060814355,0.0024040797857123332,0.0023453438019194342,
 0.002281319324063203,0.0022125185776519702,0.0021394777391767305,
 0.0020627507679226212,0.0019829032132746924,0.0019005060792042247,
 0.001816129824410246,0.0017303385723508667,0.001643684600219805,
 0.0015567031699087277,0.0014699077572602694,0.0013837857285757117,
 0.001298794505526191,0.0012153582514472835,0.0011338651036120328,
 0.0010546649675975239,0.000978067881417979,0.0009043429488113952,
 0.0008337178330532839,0.0007663787950442011,0.0007024712522654863,
 0.0006421008286278305,0.0005853348593099683,0.0005322043094822139,
 0.00048270606137739943,0.00043680552055504456,0.00039443948943224745,
 0.00035551925423943424,0.00031993383050594294,0.0002875533119756029,
 0.00025823226847619473,0.00023181313968077819,0.00020812957386210208,
 0.00018700966359435847,0.00016827903383868516,0.00015176374188743925,
 0.00013729295315915164,0.00012470136175025324,0.00011383132987304395,
 0.00010453472575483786,0.00009667444515192108,0.00009012560725235289,
 0.00008477642132193996,0.00008052872589770819,0.0000772982075793184,
 0.00007501431143255517,0.00007361985963406197,0.00007307039919228535,
 0.00007333330332170529,0.00007438665428318243,0.00007621793819490452,
 0.00007882258444171159,0.00008220238384612471,0.00008636382070727251,
 0.00009131635416220392,0.00009707068409253908,0.00010363703600309278,
 0.00011102349796898626,0.00011923444091600009,0.00012826905120883362,
 0.00013812000182072303,0.00014877228529780657,0.0001602022283708727,
 0.00017237670446472063,0.0001852525565743208,0.00019877623908252036,
 0.00021288368314626363,0.0002275003863456819,0.00024254172343080295,
 0.00025791347127366074,0.0002735125375976535,0.00028922787975748954,
 0.0003049415968353495,0.0003205301756356665,0.0003358658688440105,
 0.00035081818168968687,0.00036525544194006195,0.00037904642697335307,
 0.0003920620210337079,0.00040417687556665966,0.0004152710457660078,
 0.00042523157711255716,0.00043395401674336663,0.00044134382592564495,
 0.00044731767169604045,0.00045180457782902767,0.0004547469176796771,
 0.00045610123406160223,0.00045583887413121595,0.0004539464302004938,
 0.0004504259804514701,0.0004452951266227389,0.00043858682883510003,
 0.00043034904077357685,0.00042064415139837454,0.00040954824217512466,
 0.0003971501714564366,0.0003835505000711437,0.0003688602743557146,
 0.00035319968476182537,0.0003366966197739779,0.0003194851361493468,
 0.0003017038674379363,0.0002834943933435828,0.0002649995927431711,
 0.00024636200309614576,0.00022772220855325913,0.00020921727832773725,
 0.00019097927583918402,0.000173133857801406,0.00015579898082651946,
 0.00013908373128637588,0.00012308729214150573,0.0001078980582497325,
 0.00009359290933942938,0.00008023664741155517,0.00006788160285842115,
 0.0000565674110947367,0.00004632095902370103,0.00003715649824583179,
 0.000029075919595037656,0.000022069181388466437,0.000016114881734083227,
 0.000011180963380863597,7.225537944366562e-6,4.197814916740116e-6,
 2.039119691215345e-6,6.839839099680329e-7,6.129078940076897e-8,
 9.545769300127827e-8,7.076381092608491e-7,1.816925346880531e-6,
 3.341540673937486e-6,5.1999892902361275e-6,7.3121684177532835e-6,
 9.600412904480036e-6,0.00001199046504102733,0.00001441235676316388,
 0.00001680119403146219,0.000019097834913542064,0.00002124945471671989,
 0.0000232099933992482,0.00002494048239731106,0.000026409249912579808,
 0.00002759200558264318,0.000028471807275577497,0.000029038914484275945,
 0.000029290534420535446,0.00002923046840133022,0.00002886866745934783,
 0.000028220707280131714,0.00002730719355381883,0.00002615310961974614,
 0.00002478711886870806,0.000023240834745594537,0.00002154807136314702,
 0.000019744087697285715,0.00001786483809073077,0.00001594624135292719,
 0.000014023480120578966,0.000012130341349012777,0.000010298607854994077,
 8.557509745292922e-6,6.933243361504364e-6,5.4485640721599324e-6,
 4.122457869655192e-6,2.969895305906185e-6,2.0016698496266494e-6,
 1.2243212936260055e-6,6.401434053742632e-7,2.472736208266747e-7,
 3.986125122453069e-8,8.309425457843195e-9,1.3958484472388892e-7,
 4.1758839809882194e-7,8.235787915027741e-7,1.33664059031766e-6,
 1.9341874771083222e-6,2.5924910874111677e-6,3.2872255126697043e-6,
 3.9940174517784784e-6,4.688992050274854e-6,5.349304685510977e-6,
 5.953649330932482e-6,6.4827346546566796e-6,6.919719666117818e-6,
 7.25060150716705e-6,7.464548876315547e-6,7.554175560953473e-6,
 7.515749615369471e-6,7.349334844051251e-6,7.058862411707429e-6,
 6.652131584275905e-6,6.140739790232711e-6,5.539943359633712e-6,
 4.868451431370904e-6,4.14815659954244e-6,3.4038068813168685e-6,
 2.662624515920486e-6,1.9538779339925946e-6,1.3084139565780465e-6,
 7.581578834352858e-7,3.355896032150774e-7,7.320419747288736e-8,
 2.9657126266686625e-9};

/* Beam with adjusted grading a = 0.6834 */

char *cbi_beam_version(void)
{
  static char *v = "CBI beam 12-Oct-2001 a=0.6834";
  return v;
}

static double cbi_profile[SIZE_PROFILE] =
{1.,0.9992939752136721,0.9971785172955618,0.9936614612793143,
  0.9887558180222817,0.9824797032491707,0.974856238893833,0.9659134274133403,
  0.9556839999319261,0.9442052392488914,0.9315187789129916,
  0.9176703797246517,0.9027096851754655,0.8866899574706514,
  0.8696677959034279,0.851702839459708,0.8328574556263302,0.8131964174555212,
  0.7927865710019274,0.7716964952959277,0.74999615704782,0.7277565622916828,
  0.7050494071753572,0.6819467300841322,0.6585205672507628,
  0.6348426139537133,0.6109838933396955,0.5870144348262555,
  0.5630029639461183,0.5390166053883934,0.5151206008731517,
  0.49137804336685714,0.46784962900752974,0.4445934279617412,
  0.421664675281827,0.39911558267241687,0.37699517191187454,
  0.35534913050793615,0.3342196899990781,0.31364552714536437,
  0.29366168808606213,0.27429953537749935,0.25558671766477814,
  0.23754716158626749,0.22020108536146013,0.2035650333718651,
  0.18765193091216054,0.17247115816573547,0.15802864234584507,
  0.14432696684160157,0.1313654961175274,0.11914051503690369,
  0.10764538121303809,0.09687068893910847,0.08680444320656731,
  0.07743224229423407,0.06873746739509601,0.06070147774526332,
  0.05330380972920764,0.046522378456929386,0.04033368034156707,
  0.034712995249588714,0.029634586849418693,0.025071899847420667,
  0.020997752871763527,0.01738452584398264,0.014204340764104989,
  0.011429234927087145,0.009031325685043008,0.0069829659703309396,
  0.00525688989802066,0.003826347871581542,0.0026652307218369875,
  0.0017481825153545993,0.0010507017735533707,0.0005492309470143155,
  0.00022123408992567417,0.000045262776483813026,1.010393663276133e-6,
  0.00006935503238990784,0.00023239128119215176,0.000473451302332345,
  0.0007771156397737846,0.0011292142707391814,0.0015168184677598101,
  0.0019282240857811514,0.002352926928935912,0.002781590883957639,
  0.003206009531897007,0.0036190619669082707,0.004014663560549141,
  0.004387712412510995,0.004734032224250826,0.005050312320977939,
  0.005334045530251146,0.005583464602508005,0.005797477830657891,
  0.005975604492940677,0.006117910706123175,0.006224946235341118,
  0.00629768276306939,0.006337454073401226,0.006345898559626217,
  0.006324904413590265,0.006276557805073615,0.006203094308980937,
  0.006106853788034106,0.005990238889393533,0.005855677265681516,
  0.005705587584674484,0.005542349347872903,0.005368276496598383,
  0.005185594745527987,0.004996422547916639,0.004802755564409396,
  0.004606454478474037,0.004409235976224228,0.004212666686835784,
  0.004018159861917591,0.003826974558077954,0.0036402170764821295,
  0.0034588444063297957,0.0032836694157766587,0.003115367533714566,
  0.0029544846688271237,0.002801446118229196,0.0026565662265419475,
  0.0025200585671965123,0.0023920464308088453,0.0022725734203577503,
  0.002161613969322022,0.0020590836165915016,0.0019648488905771844,
  0.0018787366741935259,0.0018005429420029791,0.0017300407805085384,
  0.0016669876221018054,0.001611131642262607,0.001562217288047039,
  0.0015199899234693425,0.0014841995939044643,0.0014546039269438568,
  0.0014309702010862637,0.0014130766261291183,0.0014007128900509042,
  0.001393680036480867,0.0013917897444988136,0.0013948630884847385,
  0.0014027288600485467,0.0014152215367555455,0.0014321789834673357,
  0.0014534399717205469,0.0014788416007495253,0.001508216700636692,
  0.0015413912937573544,0.0015781821853069306,0.0016183947473974688,
  0.0016618209541288875,0.0017082377173295038,0.0017574055644729888,
  0.0018090676917622305,0.001862949416678413,0.0019187580455664842,
  0.001976183163208283,0.0020348973429508903,0.0020945572679332454,
  0.0021548052463971354,0.0022152710970860176,0.002275574374401699,
  0.00233532689739079,0.002394135541820021,0.002451605250622067,
  0.0025073422148809365,0.0025609571752935856,0.0026120687927019626,
  0.0026603070358111095,0.002705316534593686,0.0027467598490719257,
  0.0027843206051342533,0.0028177064517186604,0.002846651797026434,
  0.0028709202853297758,0.0028903069803407275,0.002904640225929775,
  0.0029137831601266737,0.0029176348637298005,0.002916131130387822,
  0.002909244850627084,0.002896986007877685,0.002879401290031826,
  0.0028565733253589185,0.002828619556639537,0.0027956907720874404,
  0.002757969315954805,0.002715667005599724,0.00266902278519686,
  0.0026183001491545035,0.0025637843706363414,0.002505779572355677,
  0.0024446056780064733,0.0023805952833138608,0.002314090485740252,
  0.002245439711380192,0.0021749945765625078,0.002103106820123995,
  0.0020301253403710176,0.001956393368310742,0.0018822458059740649,
  0.0018080067555546623,0.0017339872617322262,0.001660483285979951,
  0.0015877739279433496,0.0015161199051697803,0.001445762298630452,
  0.0013769215676517198,0.0013097968341689845,0.0012445654325434457,
  0.0011813827178368261,0.0011203821221694233,0.0010616754458762758,
  0.0010053533675223958,0.0009514861545199195,0.0009001245541203716,
  0.0008513008429509013,0.0008050300120397694,0.0007613110634335025,
  0.0007201283940498466,0.0006814532423283948,0.0006452451735251317,
  0.0006114535801278029,0.0005800191748290155,0.0005508754547541002,
  0.0005239501171732627,0.000499166408699784,0.000476444391952418,
  0.000455702115802814,0.0004368566776016746,0.0004198251681368023,
  0.00040452549248832235,0.00039087706236548645,0.0003788013579045574,
  0.00036822235923573564,0.000359066850358673,0.0003512645999670412,
  0.00034474842580441487,0.0003394541508917587,0.0003353204615170629,
  0.0003322886782046634,0.00033030245196904746,0.0003293073989980245,
  0.0003292506874941932,0.0003300805907332479,0.00033174602047304915,
  0.0003341960546761356,0.0003373794730990628,0.00034124431367041976,
  0.00034573746174005454,0.00035080428325533946,0.0003563883117293164,
  0.00036243099753118885,0.00036887152658117005,0.0003756467139942763,
  0.00038269097661669613,0.00038993638676655066,0.00039731280785167903,
  0.0004047481109188935,0.00041216846961964854,0.0004194987295782695,
  0.00042666284674737053,0.00043358438804677173,0.00044018708643362353,
  0.0004463954415490215,0.00045213535625308876,0.00045733479869942886,
  0.0004619244791239611,0.0004658385302321707,0.0004690151799693958,
  0.00047139740554405225,0.0004729335578438479,0.0004735779458294087,
  0.0004732913710996326,0.00047204160358807826,0.0004698037902514821,
  0.00046656078963603346,0.00046230342633855946,0.0004570306605920307,
  0.00045074966948672714,0.00044347583766064655,0.00043523265663949156,
  0.0004260515333545806,0.0004159715096955288,0.00040503889624281985,
  0.0003933068245562136,0.00038083472354725556,0.0003676877265242708,
  0.0003539360164490059,0.0003396541177750563,0.00032492014393492,
  0.0003098150101016309,0.00029442162125935717,0.0002788240458781458,
  0.00026310668559334944,0.00024735345124519764,0.0002316469554392342,
  0.00021606773144971917,0.00020069348781297244,0.0001855984073548302,
  0.00017085249867759955,0.00015652100730887607,0.00014266389280094595,
  0.00012933537708208635,0.00011658356831308018,0.0001044501634120875,
  0.00009297023129473727,0.00008217207775064133,0.00007207719175985041,
  0.0000627002719580506,0.0000540493309052369,0.000046125873811302825,
  0.000038925147439812025,0.0000324364540582334,0.000026643524541655793,
  0.000021524944076105712,0.000017054623354635477,0.000013202307720950289,
  9.9341163946403e-6,7.213103712112388e-6,4.999834238070219e-6,
  3.2529636423961176e-6,1.929817393608216e-6,9.86959587578599e-7,
  3.807446025548969e-7,6.784474083668848e-8,5.7475745224062445e-9,
  1.532173471625836e-7,4.7071548378995346e-7,9.207760164704917e-7,
  1.4683325287246486e-6,2.0809940468750543e-6,2.729268146495347e-6,
  3.386730384618154e-6,4.03014000023968e-6,4.639502634797951e-6,
  5.198081598584432e-6,5.692359937822791e-6,6.1119562300692135e-6,
  6.449497643902366e-6,6.700454334599906e-6,6.862939704260509e-6,
  6.937481427427813e-6,6.926768427964292e-6,6.835379187433712e-6,
  6.669496868728035e-6,6.436616751669434e-6,6.145251401970369e-6,
  5.804638834236426e-6,5.424458688697515e-6,5.014561125298169e-6,
  4.584712754927941e-6,4.144363483233316e-6,3.702437646570005e-6,
  3.2671522808877756e-6,2.845864792894512e-6,2.444951708113971e-6,
  2.069719563079117e-6,1.724348398597733e-6,1.4118677081280847e-6,
  1.1341641091284058e-6,8.920194453728788e-7,6.851775029412191e-7,
  5.124370400020417e-7,3.717683976862718e-7,2.604505822841533e-7,
  1.752253930448825e-7,1.1246491893742968e-7,6.83485448871956e-8,
  3.9045495010679456e-8,2.0898897929935636e-8,1.0607386869030296e-8,
  5.400343312397412e-9,3.2030549064595853e-9,2.7882822964562256e-9,
  3.9110111160567475e-9,7.423498906762116e-9,1.5368106113203918e-8,
  3.1045818621005e-8,5.905881918059789e-8,1.0532593870461031e-7,
  1.7707030778555226e-7,2.827790256460526e-7,4.3213515990393765e-7,
  6.359228779219556e-7,9.05906981283855e-7,1.2546885615940119e-6,
  1.6955389113993774e-6,2.24221420210026e-6,2.9087537755659994e-6,
  3.709265182805217e-6,4.65769933729542e-6,5.7676193291739295e-6,
  7.051966567107523e-6};

/* Return the observation-adjusted CBI primary beam response at "angle"
   radians from the pointing center at frequency "freq" GHz. */

double cbi_beam(double angle, double freq)
{
  int i;
  double a;
  /* Outer radius of antenna in cm; used to
     scale the dimensionless primary beam */
  double rmax = 45.0;
  /* Observing wavelength in cm */
  double lambda = 100.0 * LIGHTSPEED/(freq*1e9);
  /* Dimensionless radius */
  double x = angle * rmax/lambda;

  /* Check in valid range */
  if (x < 0.0 || x > (SIZE_PROFILE-1)*(STEP_PROFILE)) {
#ifdef DEBUG
    fprintf(stderr, "Error 1 in cbi_beam: %f %f %f\n",
	    angle/RPARCM, freq, x);
#endif
    return 0.0;
  }

  /* Linearly interpolate in table between entries i and i+1 */
  i = x/(STEP_PROFILE);
  a = x/(STEP_PROFILE) - i;
#ifdef DEBUG
  if (i < 0 || i > SIZE_PROFILE-2 || a < 0.0 || a > 1.0)
    fprintf(stderr, "Error 2 in cbi_beam\n");
#endif
  return cbi_profile[i] + a*(cbi_profile[i+1] - cbi_profile[i]);
}

/* Return the dessigned CBI primary beam response at "angle"
   radians from the pointing center at frequency "freq" GHz. */

double cbi_beam_design(double angle, double freq)
{
  int i;
  double a;
  /* Outer radius of antenna in cm; used to
     scale the dimensionless primary beam */
  double rmax = 45.0;
  /* Observing wavelength in cm */
  double lambda = 100.0 * LIGHTSPEED/(freq*1e9);
  /* Dimensionless radius */
  double x = angle * rmax/lambda;

  /* Check in valid range */
  if (x < 0.0 || x > (SIZE_PROFILE-1)*(STEP_PROFILE)) {
#ifdef DEBUG
    fprintf(stderr, "Error 1 in cbi_beam_design: %f %f %f\n",
	    angle/RPARCM, freq, x);
#endif
    return 0.0;
  }

  /* Linearly interpolate in table between entries i and i+1 */
  i = x/(STEP_PROFILE);
  a = x/(STEP_PROFILE) - i;
#ifdef DEBUG
  if (i < 0 || i > SIZE_PROFILE-2 || a < 0.0 || a > 1.0)
    fprintf(stderr, "Error 2 in cbi_beam2\n");
#endif
  return design_profile[i] + a*(design_profile[i+1] - design_profile[i]);
}

/* Fortran binding */

float cbibeam_(float *angle, float *freq)
{
  double arg1 = *angle;
  double arg2 = *freq;
  return cbi_beam(arg1, arg2);
}
